<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Pairing CMAQ with TropOMI Columns &#8212; pyrsig 0.4.5 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.4cbf315f70debaebd550c87a6162cf0f.min.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="pyrsig package" href="../../pyrsig.html" />
    <link rel="prev" title="Pairing CMAQ with AirNow Ozone" href="plot_cmaqairnow.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-comparisons-plot-cmaqtropomi-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="pairing-cmaq-with-tropomi-columns">
<span id="sphx-glr-auto-examples-comparisons-plot-cmaqtropomi-py"></span><h1>Pairing CMAQ with TropOMI Columns<a class="headerlink" href="#pairing-cmaq-with-tropomi-columns" title="Permalink to this heading">¶</a></h1>
<p>This example performs a simple comparison of CMAQ to TropOMI. TropOMI retrieves
total column HCHO at overpass time. The CMAQ PHOTDIAG1 outputs the column
integral at each hour.</p>
<ul class="simple">
<li><p>This analysis ignores satellite differential sensitivity, since CMAQ PHOTDIAG1
outputs the whole column with perfect sensitivity.</p></li>
<li><p>CMAQ column outputs include all molecules up to the model top defined by VGTOP
When VGTOP is 5000Pa, this includes some, but not all stratosphere. Further,
CMAQ does not have many stratosphere reactions/species. Comparisons could be
improved (e.g., with cmaqsatproc)</p></li>
</ul>
<section id="import-libraries">
<h2>Import libraries<a class="headerlink" href="#import-libraries" title="Permalink to this heading">¶</a></h2>
<p>And tell xarray to keep variable attributes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyrsig</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pycno</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>

<span class="n">xr</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;xarray.core.options.set_options object at 0x7f3185a143b0&gt;
</pre></div>
</div>
</section>
<section id="define-the-focus">
<h2>Define the focus<a class="headerlink" href="#define-the-focus" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>area/time/domain of interest</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bbox</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">130</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="s1">&#39;2019-06-01T00Z&#39;</span>
<span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;2019-06-07T00Z&#39;</span>
<span class="n">gdnam</span> <span class="o">=</span> <span class="s1">&#39;12US1&#39;</span>
<span class="n">spc</span> <span class="o">=</span> <span class="s1">&#39;NO2&#39;</span>  <span class="c1"># or NO2</span>
<span class="c1"># qtmpl = &#39;CCTM_PHOTDIAG1_%Y%m%d.nc&#39;</span>
</pre></div>
</div>
</section>
<section id="set-species-options">
<h2>Set species options<a class="headerlink" href="#set-species-options" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>area/time/domain of interest</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tdkey</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;HCHO&#39;</span><span class="p">:</span> <span class="s1">&#39;tropomi.offl.hcho.formaldehyde_tropospheric_vertical_column&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NO2&#39;</span><span class="p">:</span> <span class="s1">&#39;tropomi.offl.no2.nitrogendioxide_tropospheric_column&#39;</span>
<span class="p">}[</span><span class="n">spc</span><span class="p">]</span>
<span class="n">cdkey</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;HCHO&#39;</span><span class="p">:</span> <span class="s1">&#39;cmaq.equates.conus.integrated.HCHO_COLUMN&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NO2&#39;</span><span class="p">:</span> <span class="s1">&#39;cmaq.equates.conus.integrated.NO2_COLUMN&#39;</span><span class="p">,</span>
<span class="p">}[</span><span class="n">spc</span><span class="p">]</span>
<span class="n">tvkey</span> <span class="o">=</span> <span class="n">spc</span>
<span class="n">qvkey</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">spc</span><span class="si">}</span><span class="s1">_COLUMN&#39;</span>
</pre></div>
</div>
</section>
<section id="collect-daily-datasets">
<h2>Collect Daily Datasets<a class="headerlink" href="#collect-daily-datasets" title="Permalink to this heading">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span> <span class="o">=</span> <span class="n">pyrsig</span><span class="o">.</span><span class="n">RsigApi</span><span class="p">(</span><span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span> <span class="n">grid_kw</span><span class="o">=</span><span class="n">gdnam</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="n">gdnam</span><span class="p">)</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;1s&#39;</span><span class="p">)</span>
<span class="n">todss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cqdss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">bdate</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">:</span>
  <span class="n">edate</span> <span class="o">=</span> <span class="n">bdate</span> <span class="o">+</span> <span class="n">dt</span>
  <span class="c1"># cqdss.append(pyrsig.open_ioapi(bdate.strftime(qtmpl))[[qvkey]])</span>
  <span class="n">cqdss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
      <span class="n">api</span><span class="o">.</span><span class="n">to_ioapi</span><span class="p">(</span><span class="n">cdkey</span><span class="p">,</span> <span class="n">bdate</span><span class="o">=</span><span class="n">bdate</span><span class="p">,</span> <span class="n">edate</span><span class="o">=</span><span class="n">edate</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
          <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9.999e+36</span>
      <span class="p">)</span>
  <span class="p">)</span>
  <span class="n">todss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
      <span class="n">api</span><span class="o">.</span><span class="n">to_ioapi</span><span class="p">(</span><span class="n">tdkey</span><span class="p">,</span> <span class="n">bdate</span><span class="o">=</span><span class="n">bdate</span><span class="p">,</span> <span class="n">edate</span><span class="o">=</span><span class="n">edate</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
          <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9.999e+36</span>
      <span class="p">)</span>
  <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="mask-cmaq-like-tropomi">
<h2>Mask CMAQ like TropOMI<a class="headerlink" href="#mask-cmaq-like-tropomi" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>implicitly applies overpass time</p></li>
<li><p>implicitly cloud filter (assuming similar)</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tods</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">todss</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;TSTEP&#39;</span><span class="p">)</span>
<span class="n">cqds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">cqdss</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;TSTEP&#39;</span><span class="p">)</span>
<span class="c1"># sample CMAQ when TropOMI is valid</span>
<span class="n">tcqds</span> <span class="o">=</span> <span class="n">cqds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">tods</span><span class="p">[</span><span class="n">tvkey</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">LAY</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">mcqds</span> <span class="o">=</span> <span class="n">tcqds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;TSTEP&#39;</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">mtods</span> <span class="o">=</span> <span class="n">tods</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;TSTEP&#39;</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># CMAQ stores NO2_COLUMN and HCHO column as petamolecules/cm2</span>
<span class="n">mtods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tvkey</span><span class="si">}</span><span class="s1">_CMAQ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcqds</span><span class="p">[</span><span class="n">qvkey</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">mcqds</span><span class="p">[</span><span class="n">qvkey</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="mf">1e15</span>
<span class="n">mtods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tvkey</span><span class="si">}</span><span class="s1">_CMAQ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">units</span><span class="o">=</span><span class="s1">&#39;molecules/cm**2&#39;</span><span class="p">,</span>
    <span class="n">long_name</span><span class="o">=</span><span class="n">qvkey</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
    <span class="n">var_desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;CMAQ total column </span><span class="si">{</span><span class="n">qvkey</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="output-tropomi-with-cmaq">
<h2>Output TropOMI with CMAQ<a class="headerlink" href="#output-tropomi-with-cmaq" title="Permalink to this heading">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mtods</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TropOMI_and_CMAQ_AVG_</span><span class="si">{</span><span class="n">tvkey</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">gdnam</span><span class="si">}</span><span class="s1">.nc&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">qm</span> <span class="o">=</span> <span class="n">mtods</span><span class="p">[</span><span class="n">tvkey</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">3e15</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>
<span class="n">mtods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tvkey</span><span class="si">}</span><span class="s1">_CMAQ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">qm</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>
<span class="n">pycno</span><span class="o">.</span><span class="n">cno</span><span class="p">(</span><span class="n">mtods</span><span class="o">.</span><span class="n">crs_proj4</span><span class="p">)</span><span class="o">.</span><span class="n">drawstates</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axx</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TropOMI_and_CMAQ_AVG_</span><span class="si">{</span><span class="n">tvkey</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">gdnam</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_cmaqtropomi_001.png" srcset="../../_images/sphx_glr_plot_cmaqtropomi_001.png" alt="LAY = 0.9975, LAY = 0.9975" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 1 minutes  49.765 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-comparisons-plot-cmaqtropomi-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/a0265c47a8cb10ecb302c00cacc6d538/plot_cmaqtropomi.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_cmaqtropomi.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/f575418ff193f86769cc2875df47b80a/plot_cmaqtropomi.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_cmaqtropomi.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">pyrsig</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">pyrsig User’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">pyrsig Example Gallery</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#get-data-examples">Get data examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#timeseries-examples">Timeseries examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#oversample-examples">Oversample examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#maps-examples">Maps examples</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#comparison-examples">Comparison examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../pyrsig.html">pyrsig package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">pyrsig Example Gallery</a><ul>
  <li><a href="index.html">Comparison examples</a><ul>
      <li>Previous: <a href="plot_cmaqairnow.html" title="previous chapter">Pairing CMAQ with AirNow Ozone</a></li>
      <li>Next: <a href="../../pyrsig.html" title="next chapter">pyrsig package</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2023, Barron H. Henderson.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../../_sources/auto_examples/comparisons/plot_cmaqtropomi.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>